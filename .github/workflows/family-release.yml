# =============================================================================
# Family Skill Release Workflow
# =============================================================================
# ê³µê°œ repoì—ì„œ secretsê°€ ì£¼ìž…ëœ ë¹„ê³µê°œ ìŠ¤í‚¬ ZIPì„ ê°€ì¡±ì—ê²Œ ì´ë©”ì¼ë¡œ ì „ì†¡
#
# í•„ìš”í•œ GitHub Secrets:
#   - BEOPSUNY_OC_CODE: ë²•ë ¹ì •ë³´ì„¼í„° OC ì½”ë“œ
#   - BEOPSUNY_ASSEMBLY_API_KEY: êµ­íšŒ API í‚¤ (ì„ íƒ)
#   - MAIL_USER: Gmail ì£¼ì†Œ
#   - MAIL_APP_PASSWORD: Gmail ì•± ë¹„ë°€ë²ˆí˜¸ (2FA í•„ìš”)
#   - FAMILY_EMAILS: ìˆ˜ì‹ ìž ì´ë©”ì¼ (ì½¤ë§ˆ êµ¬ë¶„)
#
# Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ìƒì„±:
#   1. https://myaccount.google.com/apppasswords
#   2. 2ë‹¨ê³„ ì¸ì¦ í™œì„±í™” í•„ìš”
#   3. "ë©”ì¼" + "ê¸°íƒ€(ë§žì¶¤ ì´ë¦„)" ì„ íƒ â†’ 16ìžë¦¬ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
# =============================================================================

name: Family Skill Release

on:
  # ì •ì‹ ë¦´ë¦¬ì¦ˆ ì‹œ ìžë™ ë°œì†¡
  release:
    types: [published]

  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (í…ŒìŠ¤íŠ¸/ê¸´ê¸‰ ë°°í¬ìš©)
  workflow_dispatch:
    inputs:
      version:
        description: 'ë²„ì „ íƒœê·¸ (ì˜ˆ: v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (ì„ íƒ)'
        required: false
        type: string
        default: ''

# ë³´ì•ˆ: ìµœì†Œ ê¶Œí•œ ì›ì¹™
permissions:
  contents: read

jobs:
  build-and-send:
    runs-on: ubuntu-latest

    # ë²„ì „: release ì´ë²¤íŠ¸ë©´ íƒœê·¸ëª…, ìˆ˜ë™ì´ë©´ ìž…ë ¥ê°’
    env:
      VERSION: ${{ github.event.release.tag_name || inputs.version }}
      RELEASE_NOTES: ${{ github.event.release.body || inputs.release_notes || 'ìƒˆ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show release info
        run: |
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ“ Trigger: ${{ github.event_name }}"

      # ë³´ì•ˆ: secretsë¥¼ echoí•˜ì§€ ì•Šê³  íŒŒì¼ì—ë§Œ ì”€
      - name: Inject API credentials
        run: |
          cat > .claude/skills/beopsuny/config/.env <<'ENVEOF'
          # Auto-generated by GitHub Actions
          # DO NOT commit this file
          BEOPSUNY_OC_CODE=${{ secrets.BEOPSUNY_OC_CODE }}
          BEOPSUNY_ASSEMBLY_API_KEY=${{ secrets.BEOPSUNY_ASSEMBLY_API_KEY }}
          ENVEOF

          # .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ë§Œ í™•ì¸ (ë‚´ìš©ì€ ì¶œë ¥ ì•ˆí•¨)
          echo "âœ… .env file created ($(wc -c < .claude/skills/beopsuny/config/.env) bytes)"

      - name: Create skill ZIP
        run: |
          cd .claude/skills

          # ZIP ìƒì„± (ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸)
          zip -r ../../beopsuny-skill-${VERSION}.zip beopsuny \
            -x "*.pyc" \
            -x "*/__pycache__/*" \
            -x "*.git*" \
            -x "*.DS_Store"

          cd ../..
          echo "ðŸ“¦ ZIP created: $(ls -lh beopsuny-skill-${VERSION}.zip | awk '{print $5}')"

      - name: Verify ZIP contents
        run: |
          # ZIP ë‚´ìš© í™•ì¸ (íŒŒì¼ ëª©ë¡ë§Œ, ë‚´ìš©ì€ ì•ˆë´„)
          echo "ðŸ“‹ ZIP contents:"
          unzip -l beopsuny-skill-${VERSION}.zip | head -30
          echo "..."

          # .envê°€ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if unzip -l beopsuny-skill-${VERSION}.zip | grep -q ".env"; then
            echo "âœ… .env file included in ZIP"
          else
            echo "âŒ .env file missing!"
            exit 1
          fi

      - name: Send to family via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_APP_PASSWORD }}
          subject: "ë²•ìˆœì´ ìŠ¤í‚¬ ${{ env.VERSION }}"
          to: ${{ secrets.FAMILY_EMAILS }}
          from: ${{ secrets.MAIL_USER }}
          attachments: beopsuny-skill-${{ env.VERSION }}.zip
          body: |
            ë²•ìˆœì´(Beopsuny) ìŠ¤í‚¬ ${{ env.VERSION }} ë°°í¬
            ================================================

            ${{ env.RELEASE_NOTES }}

            ì„¤ì¹˜ ë°©ë²•
            ---------
            1. ì²¨ë¶€ëœ ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ
            3. Claude Desktop â†’ Settings â†’ Skills â†’ Import
            4. beopsuny í´ë” ì„ íƒ

            ì‚¬ìš©ë²•
            ------
            - ë²•ë ¹ ê²€ìƒ‰: "ë¯¼ë²• ì œ750ì¡° ì•Œë ¤ì¤˜"
            - íŒë¡€ ê²€ìƒ‰: "ì†í•´ë°°ìƒ ê´€ë ¨ íŒë¡€ ì°¾ì•„ì¤˜"
            - ì²´í¬ë¦¬ìŠ¤íŠ¸: "ìŠ¤íƒ€íŠ¸ì—… ì„¤ë¦½ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì¤˜"

            ë¬¸ì˜: GitHub Issues ë˜ëŠ” ì§ì ‘ ì—°ë½

            ---
            ìžë™ ìƒì„±: GitHub Actions
            ì»¤ë°‹: ${{ github.sha }}

      # ë³´ì•ˆ: ìž‘ì—… í›„ ë¯¼ê° íŒŒì¼ ì •ë¦¬
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f .claude/skills/beopsuny/config/.env
          rm -f beopsuny-skill-*.zip
          echo "ðŸ§¹ Cleanup completed"
