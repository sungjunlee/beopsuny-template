# =============================================================================
# Family Skill Release Workflow
# =============================================================================
# ê³µê°œ repoì—ì„œ secretsê°€ ì£¼ì…ëœ ë¹„ê³µê°œ ìŠ¤í‚¬ ZIPì„ ê°€ì¡±ì—ê²Œ ì´ë©”ì¼ë¡œ ì „ì†¡
#
# í•„ìš”í•œ GitHub Secrets (ëª¨ë‘ FAMILY_ prefix):
#
#   [API í‚¤ - ê°€ì¡±ìš© ê°œì¸ í‚¤]
#   - FAMILY_OC_CODE: ë²•ë ¹ì •ë³´ì„¼í„° OC ì½”ë“œ (í•„ìˆ˜)
#   - FAMILY_ASSEMBLY_API_KEY: êµ­íšŒ API í‚¤ (ì„ íƒ)
#   - FAMILY_GATEWAY_URL: ê²Œì´íŠ¸ì›¨ì´ URL (ì„ íƒ, í•´ì™¸ ì ‘ê·¼ìš©)
#   - FAMILY_GATEWAY_KEY: ê²Œì´íŠ¸ì›¨ì´ API í‚¤ (ì„ íƒ)
#
#   [ì´ë©”ì¼ ë°œì†¡]
#   - FAMILY_MAIL_USER: Gmail ì£¼ì†Œ
#   - FAMILY_MAIL_APP_PASSWORD: Gmail ì•± ë¹„ë°€ë²ˆí˜¸ (2FA í•„ìš”)
#   - FAMILY_EMAILS: ìˆ˜ì‹ ì ì´ë©”ì¼ (ì½¤ë§ˆ êµ¬ë¶„)
#
# ì°¸ê³ : FAMILY_ prefixëŠ” ì´ secretsê°€ "ë²•ìˆœì´ í”„ë¡œì íŠ¸ ê³µì‹"ì´ ì•„ë‹Œ
#       "ê°€ì¡± ë°°í¬ìš© ê°œì¸ í‚¤"ì„ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
#
# Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ìƒì„±:
#   1. https://myaccount.google.com/apppasswords
#   2. 2ë‹¨ê³„ ì¸ì¦ í™œì„±í™” í•„ìš”
#   3. "ë©”ì¼" + "ê¸°íƒ€(ë§ì¶¤ ì´ë¦„)" ì„ íƒ â†’ 16ìë¦¬ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
# =============================================================================

name: Family Skill Release

on:
  # ì •ì‹ ë¦´ë¦¬ì¦ˆ ì‹œ ìë™ ë°œì†¡
  release:
    types: [published]

  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (í…ŒìŠ¤íŠ¸/ê¸´ê¸‰ ë°°í¬ìš©)
  workflow_dispatch:
    inputs:
      version:
        description: 'ë²„ì „ (ë¹„ìš°ë©´ latest-YYYYMMDD-HHMM ìë™ ìƒì„±)'
        required: false
        type: string
        default: ''
      release_notes:
        description: 'ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (ì„ íƒ)'
        required: false
        type: string
        default: ''

# ë³´ì•ˆ: ìµœì†Œ ê¶Œí•œ ì›ì¹™
permissions:
  contents: read

jobs:
  build-and-send:
    runs-on: ubuntu-latest

    # ë²„ì „: release ì´ë²¤íŠ¸ë©´ íƒœê·¸ëª…, ìˆ˜ë™ì´ë©´ ì…ë ¥ê°’
    env:
      VERSION: ${{ github.event.release.tag_name || inputs.version }}
      RELEASE_NOTES: ${{ github.event.release.body || inputs.release_notes || 'ìƒˆ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version
        run: |
          if [ -n "$VERSION" ]; then
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          else
            # ë²„ì „ ë¯¸ì…ë ¥ ì‹œ ìë™ ìƒì„±: latest-YYYYMMDD-HHMM
            AUTO_VERSION="latest-$(date -u +'%Y%m%d-%H%M')"
            echo "VERSION=$AUTO_VERSION" >> $GITHUB_ENV
          fi

      - name: Show release info
        run: |
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“ Trigger: ${{ github.event_name }}"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # build_skill.pyë¥¼ ì‚¬ìš©í•˜ì—¬ ZIP ìƒì„± (secrets ì£¼ì…)
      - name: Build skill ZIP with secrets
        run: |
          # í•„ìˆ˜ secret ê²€ì¦
          if [ -z "${{ secrets.FAMILY_OC_CODE }}" ]; then
            echo "âŒ Error: FAMILY_OC_CODE secret is not set!"
            echo "Settings â†’ Secrets â†’ Actionsì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          # ë¹Œë“œ ëª…ë ¹ êµ¬ì„± (secretsëŠ” echo ì•ˆí•¨)
          BUILD_CMD="python build_skill.py --oc-code='${{ secrets.FAMILY_OC_CODE }}' --force"

          # ì„ íƒì  ì¸ì ì¶”ê°€
          if [ -n "${{ secrets.FAMILY_ASSEMBLY_API_KEY }}" ]; then
            BUILD_CMD="$BUILD_CMD --assembly-key='${{ secrets.FAMILY_ASSEMBLY_API_KEY }}'"
          fi

          if [ -n "${{ secrets.FAMILY_GATEWAY_URL }}" ]; then
            BUILD_CMD="$BUILD_CMD --gateway-url='${{ secrets.FAMILY_GATEWAY_URL }}'"
          fi

          if [ -n "${{ secrets.FAMILY_GATEWAY_KEY }}" ]; then
            BUILD_CMD="$BUILD_CMD --gateway-key='${{ secrets.FAMILY_GATEWAY_KEY }}'"
          fi

          # ë¹Œë“œ ì‹¤í–‰ (ëª…ë ¹ ìì²´ëŠ” ì¶œë ¥ ì•ˆí•¨ - secrets í¬í•¨)
          eval $BUILD_CMD

          # ë²„ì „ëª…ìœ¼ë¡œ ë¦¬ë„¤ì„
          mv beopsuny-skill.zip beopsuny-skill-${VERSION}.zip
          echo "ğŸ“¦ ZIP created: $(ls -lh beopsuny-skill-${VERSION}.zip | awk '{print $5}')"

      - name: Verify ZIP contents
        run: |
          # ZIP ë‚´ìš© í™•ì¸ (íŒŒì¼ ëª©ë¡ë§Œ, ë‚´ìš©ì€ ì•ˆë´„)
          echo "ğŸ“‹ ZIP contents:"
          unzip -l beopsuny-skill-${VERSION}.zip | head -30
          echo "..."

          # settings.yamlì´ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if unzip -l beopsuny-skill-${VERSION}.zip | grep -q "settings.yaml"; then
            echo "âœ… settings.yaml included in ZIP"
          else
            echo "âŒ settings.yaml missing!"
            exit 1
          fi

      - name: Send to family via email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.FAMILY_MAIL_USER }}
          password: ${{ secrets.FAMILY_MAIL_APP_PASSWORD }}
          subject: "ë²•ìˆœì´ ìŠ¤í‚¬ ${{ env.VERSION }}"
          to: ${{ secrets.FAMILY_EMAILS }}
          from: ${{ secrets.FAMILY_MAIL_USER }}
          attachments: beopsuny-skill-${{ env.VERSION }}.zip
          body: |
            ë²•ìˆœì´(Beopsuny) ìŠ¤í‚¬ ${{ env.VERSION }} ë°°í¬
            ================================================

            ${{ env.RELEASE_NOTES }}

            ì„¤ì¹˜ ë°©ë²•
            ---------
            1. ì²¨ë¶€ëœ ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            2. ì••ì¶• í•´ì œ
            3. Claude Desktop â†’ Settings â†’ Skills â†’ Import
            4. beopsuny í´ë” ì„ íƒ

            ì‚¬ìš©ë²•
            ------
            - ë²•ë ¹ ê²€ìƒ‰: "ë¯¼ë²• ì œ750ì¡° ì•Œë ¤ì¤˜"
            - íŒë¡€ ê²€ìƒ‰: "ì†í•´ë°°ìƒ ê´€ë ¨ íŒë¡€ ì°¾ì•„ì¤˜"
            - ì²´í¬ë¦¬ìŠ¤íŠ¸: "ìŠ¤íƒ€íŠ¸ì—… ì„¤ë¦½ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì¤˜"

            ë¬¸ì˜: GitHub Issues ë˜ëŠ” ì§ì ‘ ì—°ë½

            ---
            ìë™ ìƒì„±: GitHub Actions
            ì»¤ë°‹: ${{ github.sha }}

      # ë³´ì•ˆ: ì‘ì—… í›„ ë¯¼ê° íŒŒì¼ ì •ë¦¬
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f beopsuny-skill-*.zip
          rm -f beopsuny-skill.zip
          echo "ğŸ§¹ Cleanup completed"
