# ============================================================
# Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄÎ≥¥Ïàò ÏûêÎèôÌôî
# Data Maintenance Automation
# ============================================================
# Î≤ïÎ†π Í∞úÏ†ï Í∞êÏßÄ Î∞è Îç∞Ïù¥ÌÑ∞ Ïã†ÏÑ†ÎèÑ ÌôïÏù∏ÏùÑ ÏûêÎèôÌôîÌï©ÎãàÎã§.
#
# Ïã§Ìñâ Ï£ºÍ∏∞:
#   - Î≤ïÎ†π Í∞úÏ†ï Í∞êÏßÄ: Îß§Ïõî 1Ïùº 09:00 KST
#   - Ïã†ÏÑ†ÎèÑ Î¶¨Ìè¨Ìä∏: Îß§Ï£º ÏõîÏöîÏùº 09:00 KST
#   - Ï°∞Î¨∏ Í≤ÄÏ¶ù: Îß§ Î∂ÑÍ∏∞ Ï≤´ÎÇ† (1/1, 4/1, 7/1, 10/1) 09:00 KST
#   - ÌóàÍ∞Ä/Ïã†Í≥† Í≤ÄÏ¶ù: Îß§ Î∂ÑÍ∏∞ Ï≤´ÎÇ† (1/1, 4/1, 7/1, 10/1) 09:00 KST
#
# ÌïÑÏöîÌïú Secrets:
#   - FAMILY_OC_CODE: law.go.kr API Ïù∏Ï¶ù ÏΩîÎìú (Í∏∞Ï°¥ family-releaseÏôÄ Í≥µÏú†)
#
# Exit codes:
#   - 0: ÏÑ±Í≥µ, Î≥ÄÍ≤Ω ÏóÜÏùå
#   - 1: ÏÑ±Í≥µ, Î≥ÄÍ≤Ω Í∞êÏßÄÎê® (Issue ÏÉùÏÑ± ÌïÑÏöî)
#   - 2: Ïò§Î•ò Î∞úÏÉù
# ============================================================

name: Data Maintenance

on:
  schedule:
    # Îß§Ïõî 1Ïùº 00:00 UTC (KST 09:00) - Î≤ïÎ†π Í∞úÏ†ï Í∞êÏßÄ
    - cron: '0 0 1 * *'
    # Îß§Ï£º ÏõîÏöîÏùº 00:00 UTC (KST 09:00) - Ïã†ÏÑ†ÎèÑ Î¶¨Ìè¨Ìä∏
    - cron: '0 0 * * 1'
    # Î∂ÑÍ∏∞ Ï≤´ÎÇ† 00:00 UTC (KST 09:00) - Ï°∞Î¨∏ Í≤ÄÏ¶ù (1/1, 4/1, 7/1, 10/1)
    - cron: '0 0 1 1,4,7,10 *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Ïã§ÌñâÌï† ÏûëÏóÖ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - check-law-updates
          - freshness-report
          - validate-citations
          - validate-permits

env:
  SCRIPTS_DIR: .claude/skills/beopsuny/scripts

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Î≤ïÎ†π Í∞úÏ†ï Í∞êÏßÄ (Îß§Ïõî 1Ïùº)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-law-updates:
    name: Check Law Amendments
    runs-on: ubuntu-latest
    # Îß§Ïõî 1Ïùº Ïä§ÏºÄÏ§Ñ ÎòêÎäî ÏàòÎèô Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'check-law-updates')
      ||
      github.event_name == 'schedule' && github.event.schedule == '0 0 1 * *'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Build reverse index
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: python maintenance/build_law_index.py --save

      - name: Check law amendments
        id: check
        working-directory: ${{ env.SCRIPTS_DIR }}
        env:
          BEOPSUNY_OC_CODE: ${{ secrets.FAMILY_OC_CODE }}
        run: |
          set +e  # ÏóêÎü¨ Î∞úÏÉùÌï¥ÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
          python maintenance/check_law_updates.py --days 35 --markdown > report.md 2>&1
          exit_code=$?
          set -e

          # Exit code Ìï¥ÏÑù
          # 0: Î≥ÄÍ≤Ω ÏóÜÏùå
          # 1: Î≥ÄÍ≤Ω Í∞êÏßÄÎê®
          # 2+: Ïò§Î•ò Î∞úÏÉù
          if [ $exit_code -eq 0 ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "::error::Script failed with exit code $exit_code"
            cat report.md
            exit $exit_code
          fi

      - name: Create Issue if amendments found
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üîî Î≤ïÎ†π Í∞úÏ†ï Í∞êÏßÄ (${new Date().toISOString().slice(0, 7)})`;
            const body = `${{ steps.check.outputs.report }}`;

            // Í∏∞Ï°¥ Ïù¥Ïäà ÌôïÏù∏
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maintenance,law-update',
            });

            const thisMonth = new Date().toISOString().slice(0, 7);
            const existingThisMonth = existingIssues.data.find(issue =>
              issue.title.includes(thisMonth)
            );

            if (existingThisMonth) {
              // Í∏∞Ï°¥ Ïù¥Ïäà ÏóÖÎç∞Ïù¥Ìä∏
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingThisMonth.number,
                body: body,
              });
              console.log(`Updated existing issue #${existingThisMonth.number}`);
            } else {
              // ÏÉà Ïù¥Ïäà ÏÉùÏÑ±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['maintenance', 'law-update'],
              });
              console.log('Created new issue');
            }

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Ïã†ÏÑ†ÎèÑ Î¶¨Ìè¨Ìä∏ (Îß§Ï£º ÏõîÏöîÏùº)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  freshness-report:
    name: Data Freshness Report
    runs-on: ubuntu-latest
    # Îß§Ï£º ÏõîÏöîÏùº Ïä§ÏºÄÏ§Ñ ÎòêÎäî ÏàòÎèô Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'freshness-report')
      ||
      github.event_name == 'schedule' && github.event.schedule == '0 0 * * 1'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate freshness report
        id: report
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: |
          set +e
          python maintenance/freshness_report.py --markdown > report.md 2>&1
          exit_code=$?
          set -e

          # Exit code Ìï¥ÏÑù
          # 0: Í∏∞Ìïú Ï¥àÍ≥º ÏóÜÏùå
          # 1: Í∏∞Ìïú Ï¥àÍ≥º ÌååÏùº ÏûàÏùå
          # 2+: Ïò§Î•ò Î∞úÏÉù
          if [ $exit_code -eq 0 ]; then
            echo "has_overdue=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            echo "has_overdue=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "::error::Script failed with exit code $exit_code"
            cat report.md
            exit $exit_code
          fi

      - name: Create Issue if overdue files found
        if: steps.report.outputs.has_overdue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üìÖ Îç∞Ïù¥ÌÑ∞ Î¶¨Î∑∞ ÌïÑÏöî (${new Date().toISOString().slice(0, 10)})`;
            const body = `${{ steps.report.outputs.report }}`;

            // Í∏∞Ï°¥ Ïó¥Î¶∞ Ïù¥Ïäà ÌôïÏù∏
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maintenance,freshness',
            });

            if (existingIssues.data.length > 0) {
              // Í∞ÄÏû• ÏµúÍ∑º Ïù¥Ïäà ÏóÖÎç∞Ïù¥Ìä∏
              const latestIssue = existingIssues.data[0];
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: latestIssue.number,
                body: body,
              });
              console.log(`Updated existing issue #${latestIssue.number}`);
            } else {
              // ÏÉà Ïù¥Ïäà ÏÉùÏÑ±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['maintenance', 'freshness'],
              });
              console.log('Created new issue');
            }

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Ï°∞Î¨∏ Í≤ÄÏ¶ù (Î∂ÑÍ∏∞Î≥Ñ: 1/1, 4/1, 7/1, 10/1)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  validate-citations:
    name: Validate Citations
    runs-on: ubuntu-latest
    # Î∂ÑÍ∏∞ Ï≤´ÎÇ† Ïä§ÏºÄÏ§Ñ ÎòêÎäî ÏàòÎèô Ïã§Ìñâ (allÏùÄ API Ìò∏Ï∂ú Ï†úÌïúÏúºÎ°ú Ï†úÏô∏)
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'validate-citations'
      ||
      github.event_name == 'schedule' && github.event.schedule == '0 0 1 1,4,7,10 *'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate citations
        id: validate
        working-directory: ${{ env.SCRIPTS_DIR }}
        env:
          BEOPSUNY_OC_CODE: ${{ secrets.FAMILY_OC_CODE }}
        run: |
          set +e
          # ÏÉòÌîå Í≤ÄÏ¶ù (API Ìò∏Ï∂ú Ï†úÌïú Í≥†Î†§)
          python maintenance/validate_citations.py --sample 20 --markdown > report.md 2>&1
          exit_code=$?
          set -e

          # Exit code Ìï¥ÏÑù
          # 0: Î™®Îëê Ïú†Ìö®
          # 1: Î¨¥Ìö® Ï°∞Î¨∏ Î∞úÍ≤¨
          # 2+: Ïò§Î•ò Î∞úÏÉù
          if [ $exit_code -eq 0 ]; then
            echo "has_invalid=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "::error::Script failed with exit code $exit_code"
            cat report.md
            exit $exit_code
          fi

      - name: Create Issue if invalid citations found
        if: steps.validate.outputs.has_invalid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üìã Ï°∞Î¨∏ Í≤ÄÏ¶ù ÌïÑÏöî (${new Date().toISOString().slice(0, 7)})`;
            const body = `${{ steps.validate.outputs.report }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'citation-check'],
            });
            console.log('Created citation validation issue');

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # ÌóàÍ∞Ä/Ïã†Í≥† Í≤ÄÏ¶ù (Î∂ÑÍ∏∞Î≥Ñ: 1/1, 4/1, 7/1, 10/1)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  validate-permits:
    name: Validate Permits
    runs-on: ubuntu-latest
    # Î∂ÑÍ∏∞ Ï≤´ÎÇ† Ïä§ÏºÄÏ§Ñ ÎòêÎäî ÏàòÎèô Ïã§Ìñâ
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'validate-permits'
      ||
      github.event_name == 'schedule' && github.event.schedule == '0 0 1 1,4,7,10 *'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate permits
        id: validate
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: |
          set +e
          python maintenance/validate_permits.py --markdown > report.md 2>&1
          exit_code=$?
          set -e

          # Exit code Ìï¥ÏÑù
          # 0: Î™®Îëê Ïú†Ìö®
          # 1: Í≤ÄÏ¶ù Ïã§Ìå® Ìï≠Î™© Î∞úÍ≤¨
          # 2+: Ïò§Î•ò Î∞úÏÉù
          if [ $exit_code -eq 0 ]; then
            echo "has_invalid=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -eq 1 ]; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "::error::Script failed with exit code $exit_code"
            cat report.md
            exit $exit_code
          fi

      - name: Create Issue if invalid permits found
        if: steps.validate.outputs.has_invalid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üìã ÌóàÍ∞Ä/Ïã†Í≥† Í≤ÄÏ¶ù ÌïÑÏöî (${new Date().toISOString().slice(0, 7)})`;
            const body = `${{ steps.validate.outputs.report }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'permit-check'],
            });
            console.log('Created permit validation issue');
