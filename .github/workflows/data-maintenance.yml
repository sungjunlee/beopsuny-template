# ============================================================
# ë°ì´í„° ìœ ì§€ë³´ìˆ˜ ìë™í™”
# Data Maintenance Automation
# ============================================================
# ë²•ë ¹ ê°œì • ê°ì§€ ë° ë°ì´í„° ì‹ ì„ ë„ í™•ì¸ì„ ìë™í™”í•©ë‹ˆë‹¤.
#
# ì‹¤í–‰ ì£¼ê¸°:
#   - ë²•ë ¹ ê°œì • ê°ì§€: ë§¤ì›” 1ì¼ 09:00 KST
#   - ì‹ ì„ ë„ ë¦¬í¬íŠ¸: ë§¤ì£¼ ì›”ìš”ì¼ 09:00 KST
#   - ì¡°ë¬¸ ê²€ì¦: ë§¤ ë¶„ê¸° ì²«ë‚  (1/1, 4/1, 7/1, 10/1)
#
# í•„ìš”í•œ Secrets:
#   - FAMILY_OC_CODE: law.go.kr API ì¸ì¦ ì½”ë“œ (ê¸°ì¡´ family-releaseì™€ ê³µìœ )
# ============================================================

name: Data Maintenance

on:
  schedule:
    # ë§¤ì›” 1ì¼ 00:00 UTC (KST 09:00)
    - cron: '0 0 1 * *'
    # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 UTC (KST 09:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      task:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - check-law-updates
          - freshness-report
          - validate-citations

env:
  SCRIPTS_DIR: .claude/skills/beopsuny/scripts

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ë²•ë ¹ ê°œì • ê°ì§€ (ë§¤ì›” 1ì¼)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  check-law-updates:
    name: Check Law Amendments
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 1 * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'check-law-updates'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Build reverse index
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: python maintenance/build_law_index.py --save

      - name: Check law amendments
        id: check
        working-directory: ${{ env.SCRIPTS_DIR }}
        env:
          BEOPSUNY_OC_CODE: ${{ secrets.FAMILY_OC_CODE }}
        run: |
          # ë§ˆì§€ë§‰ í™•ì¸ì¼ ì´í›„ ê°œì • ê°ì§€
          python maintenance/check_law_updates.py --days 35 --markdown > report.md 2>&1 || true

          # ê²°ê³¼ë¥¼ GitHub outputìœ¼ë¡œ ì „ë‹¬
          if [ -s report.md ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            # ë©€í‹°ë¼ì¸ ì¶œë ¥
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if amendments found
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ”” ë²•ë ¹ ê°œì • ê°ì§€ (${new Date().toISOString().slice(0, 7)})`;
            const body = `${{ steps.check.outputs.report }}`;

            // ê¸°ì¡´ ì´ìŠˆ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maintenance,law-update',
            });

            const thisMonth = new Date().toISOString().slice(0, 7);
            const existingThisMonth = existingIssues.data.find(issue =>
              issue.title.includes(thisMonth)
            );

            if (existingThisMonth) {
              // ê¸°ì¡´ ì´ìŠˆ ì—…ë°ì´íŠ¸
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingThisMonth.number,
                body: body,
              });
              console.log(`Updated existing issue #${existingThisMonth.number}`);
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['maintenance', 'law-update'],
              });
              console.log('Created new issue');
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ì‹ ì„ ë„ ë¦¬í¬íŠ¸ (ë§¤ì£¼ ì›”ìš”ì¼)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  freshness-report:
    name: Data Freshness Report
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 1' || github.event.inputs.task == 'all' || github.event.inputs.task == 'freshness-report'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate freshness report
        id: report
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: |
          python maintenance/freshness_report.py --markdown > report.md 2>&1 || true

          # ê¸°í•œ ì´ˆê³¼ íŒŒì¼ í™•ì¸
          if python maintenance/freshness_report.py --overdue 2>/dev/null | grep -q "ì¼ ì´ˆê³¼"; then
            echo "has_overdue=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "has_overdue=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if overdue files found
        if: steps.report.outputs.has_overdue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ“… ë°ì´í„° ë¦¬ë·° í•„ìš” (${new Date().toISOString().slice(0, 10)})`;
            const body = `${{ steps.report.outputs.report }}`;

            // ê¸°ì¡´ ì—´ë¦° ì´ìŠˆ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maintenance,freshness',
            });

            if (existingIssues.data.length > 0) {
              // ê°€ì¥ ìµœê·¼ ì´ìŠˆ ì—…ë°ì´íŠ¸
              const latestIssue = existingIssues.data[0];
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: latestIssue.number,
                body: body,
              });
              console.log(`Updated existing issue #${latestIssue.number}`);
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['maintenance', 'freshness'],
              });
              console.log('Created new issue');
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ì¡°ë¬¸ ê²€ì¦ (ë¶„ê¸°ë³„)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-citations:
    name: Validate Citations
    runs-on: ubuntu-latest
    # ë¶„ê¸° ì²« ë‹¬ì˜ 1ì¼ì—ë§Œ ì‹¤í–‰ (1ì›”, 4ì›”, 7ì›”, 10ì›”)
    if: |
      (github.event.schedule == '0 0 1 * *' && contains('1,4,7,10', format('{0}', github.run_number))) ||
      github.event.inputs.task == 'validate-citations'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate citations
        id: validate
        working-directory: ${{ env.SCRIPTS_DIR }}
        env:
          BEOPSUNY_OC_CODE: ${{ secrets.FAMILY_OC_CODE }}
        run: |
          # ìƒ˜í”Œ ê²€ì¦ (API í˜¸ì¶œ ì œí•œ ê³ ë ¤)
          python maintenance/validate_citations.py --sample 20 --markdown > report.md 2>&1 || true

          # ë¬´íš¨ ì¡°ë¬¸ í™•ì¸
          if grep -q "âŒ ë¬´íš¨" report.md; then
            echo "has_invalid=true" >> $GITHUB_OUTPUT
            {
              echo 'report<<EOF'
              cat report.md
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "has_invalid=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if invalid citations found
        if: steps.validate.outputs.has_invalid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸ“‹ ì¡°ë¬¸ ê²€ì¦ í•„ìš” (${new Date().toISOString().slice(0, 7)})`;
            const body = `${{ steps.validate.outputs.report }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'citation-check'],
            });
            console.log('Created citation validation issue');
